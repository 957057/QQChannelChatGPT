import{k as A,o as d,c as r,w as a,b as e,n as s,C as V,e as u,t as p,z as k,p as g,Y as z,G as M,Z as L,D as y,B as C,l as c,_ as H,$ as N,F as f,r as x,a0 as T,H as U,a1 as q,V as O,A as B,g as v,L as b,K as w,a2 as W,v as m,a3 as Z,M as _,E as $,J as E,a4 as J,f as D,a5 as K}from"./index-d089162b.js";import{W as P}from"./WaitingForRestart-cde6f809.js";import{_ as F}from"./ConsoleDisplayer-721c13f2.js";import"./_plugin-vue_export-helper-c27b6911.js";import"./common-40607810.js";const Y={class:"d-sm-flex align-center justify-space-between"},R=A({__name:"ExtensionCard",props:{title:String,link:String},setup(n){const t=n,o=l=>{window.open(l,"_blank")};return(l,i)=>(d(),r(C,{variant:"outlined",elevation:"0",class:"withbg"},{default:a(()=>[e(z,{style:{padding:"10px 14px"}},{default:a(()=>[s("div",Y,[e(V,{style:{"font-size":"17px"}},{default:a(()=>[u(p(t.title),1)]),_:1}),e(k),e(g,{variant:"plain",onClick:i[0]||(i[0]=h=>o(t.link))},{default:a(()=>[u("仓库")]),_:1})])]),_:1}),e(M),e(y,null,{default:a(()=>[L(l.$slots,"default")]),_:3})]),_:3}))}}),Q={class:"d-sm-flex align-center justify-space-between"},X=A({__name:"UiParentCard",props:{title:String},setup(n){const t=n;return(o,l)=>(d(),r(C,{variant:"outlined",elevation:"0",class:"withbg"},{default:a(()=>[e(z,null,{default:a(()=>[s("div",Q,[e(V,null,{default:a(()=>[u(p(t.title),1)]),_:1}),L(o.$slots,"action")])]),_:3}),e(M),e(y,null,{default:a(()=>[L(o.$slots,"default")]),_:3})]),_:3}))}}),I={__name:"ConfigDetailCard",props:{config:Array},setup(n){return(t,o)=>(d(),c(f,null,[H(s("a",null,"该插件没有配置",512),[[N,n.config.length===0]]),(d(!0),c(f,null,x(n.config,l=>(d(),r(X,{key:l.name,title:l.name,style:{"margin-bottom":"16px"}},{default:a(()=>[(d(!0),c(f,null,x(l.body,i=>(d(),c(f,null,[i.config_type==="item"?(d(),c(f,{key:0},[i.val_type==="bool"?(d(),r(T,{key:0,modelValue:i.value,"onUpdate:modelValue":h=>i.value=h,label:i.name,hint:i.description,color:"primary",inset:""},null,8,["modelValue","onUpdate:modelValue","label","hint"])):i.val_type==="str"?(d(),r(U,{key:1,modelValue:i.value,"onUpdate:modelValue":h=>i.value=h,label:i.name,hint:i.description,style:{"margin-bottom":"8px"},variant:"outlined"},null,8,["modelValue","onUpdate:modelValue","label","hint"])):i.val_type==="int"?(d(),r(U,{key:2,modelValue:i.value,"onUpdate:modelValue":h=>i.value=h,label:i.name,hint:i.description,style:{"margin-bottom":"8px"},variant:"outlined"},null,8,["modelValue","onUpdate:modelValue","label","hint"])):i.val_type==="list"?(d(),c(f,{key:3},[s("span",null,p(i.name),1),e(q,{modelValue:i.value,"onUpdate:modelValue":h=>i.value=h,chips:"",clearable:"",label:"请添加",multiple:"","prepend-icon":"mdi-tag-multiple-outline"},{selection:a(({attrs:h,item:S,select:j,selected:G})=>[e(O,B(h,{"model-value":G,closable:"",onClick:j,"onClick:close":vt=>t.remove(S)}),{default:a(()=>[s("strong",null,p(S),1)]),_:2},1040,["model-value","onClick","onClick:close"])]),_:2},1032,["modelValue","onUpdate:modelValue"])],64)):v("",!0)],64)):i.config_type==="divider"?(d(),r(M,{key:1,style:{"margin-top":"8px","margin-bottom":"8px"}})):v("",!0)],64))),256))]),_:2},1032,["title"]))),128))],64))}},tt=s("div",{style:{"background-color":"white",width:"100%",padding:"16px","border-radius":"10px"}},[s("h3",null,"🧩 已安装的插件")],-1),et={style:{"min-height":"150px","max-height":"150px",overflow:"hidden"}},at={class:"d-flex align-center gap-2"},lt=s("div",{style:{"background-color":"white",width:"100%",padding:"16px","border-radius":"10px"}},[s("h3",null,"🧩 插件市场")],-1),nt={style:{"min-height":"150px","max-height":"150px",overflow:"hidden"}},ot={class:"d-flex align-center gap-2"},it=s("span",{class:"text-h5"},"插件配置",-1),st=s("span",{class:"text-h5"},"安装插件",-1),dt=s("h3",null,"从 GitHub 上在线下载",-1),ut=s("small",null,"请输入合法的 GitHub 仓库链接，当前仅支持 GitHub。如：https://github.com/Soulter/astrbot_plugin_aiocqhttp",-1),rt=s("h3",null,"从本机上传 .zip 压缩包",-1),gt=s("small",null,"请保证插件文件存在压缩包根目录中的第一个文件夹中（即类似于从 GitHub 仓库页上下载的 Zip 压缩包的格式）。",-1),pt=s("br",null,null,-1),ht={class:"text-h5"},ct={key:0,class:"py-12 text-center"},ft={class:"text-h4 font-weight-bold"},mt={style:{"margin-top":"32px"}},_t=s("h3",null,"日志",-1),kt={name:"ExtensionPage",components:{ExtensionCard:R,ConfigDetailCard:I,WaitingForRestart:P,ConsoleDisplayer:F},data(){return{extension_data:{data:[]},extension_url:"",status:"",dialog:!1,snack_message:"",snack_show:!1,snack_success:"success",loading_:!1,configDialog:!1,extension_config:{},upload_file:null,pluginMarketData:{},loadingDialog:{show:!1,title:"加载中...",statusCode:0,result:""}}},mounted(){this.getExtensions(),this.fetchPluginCollection()},methods:{toast(n,t){this.snack_message=n,this.snack_show=!0,this.snack_success=t},resetLoadingDialog(){this.loadingDialog={show:!1,title:"加载中...",statusCode:0,result:""}},onLoadingDialogResult(n,t,o=2e3){this.loadingDialog.statusCode=n,this.loadingDialog.result=t,o!==-1&&setTimeout(()=>{this.resetLoadingDialog()},o)},getExtensions(){m.get("/api/plugin/get").then(n=>{this.extension_data.data=n.data.data,this.checkAlreadyInstalled()})},newExtension(){if(this.extension_url===""&&this.upload_file===null){this.toast("请填写插件链接或上传插件文件","error");return}if(this.extension_url!==""&&this.upload_file!==null){this.toast("请不要同时填写插件链接和上传插件文件","error");return}if(this.loading_=!0,this.loadingDialog.show=!0,this.upload_file!==null){this.toast("正在从文件安装插件","primary");const n=new FormData;n.append("file",this.upload_file[0]),m.post("/api/plugin/install-upload",n,{headers:{"Content-Type":"multipart/form-data"}}).then(t=>{if(this.loading_=!1,t.data.status==="error"){this.onLoadingDialogResult(2,t.data.message,-1);return}this.extension_data.data=t.data.data,this.upload_file="",this.onLoadingDialogResult(1,t.data.message),this.dialog=!1,this.$refs.wfr.check()}).catch(t=>{this.loading_=!1,this.onLoadingDialogResult(2,t,-1)});return}else this.toast("正在从链接 "+this.extension_url+" 安装插件...","primary"),m.post("/api/plugin/install",{url:this.extension_url}).then(n=>{if(this.loading_=!1,n.data.status==="error"){this.onLoadingDialogResult(2,n.data.message,-1);return}this.extension_data.data=n.data.data,console.log(this.extension_data),this.extension_url="",this.onLoadingDialogResult(1,n.data.message),this.dialog=!1,this.$refs.wfr.check()}).catch(n=>{this.loading_=!1,this.onLoadingDialogResult(2,n,-1)})},uninstallExtension(n){this.toast("正在卸载"+n,"primary"),m.post("/api/plugin/uninstall",{name:n}).then(t=>{if(t.data.status==="error"){this.toast(t.data.message,"error");return}this.extension_data.data=t.data.data,this.toast(t.data.message,"success"),this.dialog=!1,this.getExtensions()}).catch(t=>{this.toast(t,"error")})},updateExtension(n){this.loadingDialog.show=!0,m.post("/api/plugin/update",{name:n}).then(t=>{if(t.data.status==="error"){this.onLoadingDialogResult(2,t.data.message,-1);return}this.extension_data.data=t.data.data,console.log(this.extension_data),this.onLoadingDialogResult(1,t.data.message),this.dialog=!1,this.$refs.wfr.check()}).catch(t=>{this.toast(t,"error")})},openExtensionConfig(n){this.curr_namespace=n,this.configDialog=!0,m.get("/api/config/get?namespace="+n).then(t=>{this.extension_config=t.data.data,console.log(this.extension_config)}).catch(t=>{this.toast(t,"error")})},updateConfig(){m.post("/api/config/plugin/update",{config:this.extension_config,namespace:this.curr_namespace}).then(n=>{n.data.status==="ok"?(this.toast(n.data.message,"success"),this.$refs.wfr.check()):this.toast(n.data.message,"error")}).catch(n=>{this.toast(n,"error")})},fetchPluginCollection(){let n="https://soulter.github.io/AstrBot_Plugins_Collection/plugins.json";m.get(n).then(t=>{let o=[];this.pluginMarketDataOrigin=t.data;for(let l in t.data)o.push({name:l,desc:t.data[l].desc,author:t.data[l].author,repo:t.data[l].repo,installed:!1});this.pluginMarketData=o,this.checkAlreadyInstalled()}).catch(t=>{this.toast("获取插件市场数据失败: "+t,"error")})},checkAlreadyInstalled(){for(let n=0;n<this.pluginMarketData.length;n++)this.pluginMarketData[n].installed=!1;for(let n=0;n<this.pluginMarketData.length;n++)for(let t=0;t<this.extension_data.data.length;t++)this.pluginMarketData[n].repo===this.extension_data.data[t].repo&&(this.pluginMarketData[n].installed=!0)}}},xt=Object.assign(kt,{setup(n){return(t,o)=>(d(),c(f,null,[e(b,null,{default:a(()=>[e(Z,{style:{margin:"16px"},text:"1. 如果因为网络问题安装失败，可以前往 配置->其他配置->插件仓库镜像 修改安装镜像源。2. 如需插件帮助请点击 `仓库` 查看 README",title:"💡小提示",type:"info",variant:"tonal"}),e(_,{cols:"12",md:"12"},{default:a(()=>[tt]),_:1}),(d(!0),c(f,null,x(t.extension_data.data,l=>(d(),r(_,{cols:"12",md:"6",lg:"4"},{default:a(()=>[(d(),r(R,{key:l.name,title:l.name,link:l.repo,style:{"margin-bottom":"4px"}},{default:a(()=>[s("p",et,p(l.desc),1),s("div",at,[e(D,null,{default:a(()=>[u("mdi-account")]),_:1}),s("span",null,p(l.author),1),e(k),e(g,{variant:"plain",onClick:i=>t.openExtensionConfig(l.name)},{default:a(()=>[u("配置")]),_:2},1032,["onClick"]),e(g,{variant:"plain",onClick:i=>t.updateExtension(l.name)},{default:a(()=>[u("更新")]),_:2},1032,["onClick"]),e(g,{variant:"plain",onClick:i=>t.uninstallExtension(l.name)},{default:a(()=>[u("卸载")]),_:2},1032,["onClick"])])]),_:2},1032,["title","link"]))]),_:2},1024))),256)),e(_,{cols:"12",md:"12"},{default:a(()=>[lt]),_:1}),(d(!0),c(f,null,x(t.pluginMarketData,l=>(d(),r(_,{cols:"12",md:"6",lg:"4"},{default:a(()=>[(d(),r(R,{key:l.name,title:l.name,link:l.repo,style:{"margin-bottom":"4px"}},{default:a(()=>[s("p",nt,p(l.desc),1),s("div",ot,[e(D,null,{default:a(()=>[u("mdi-account")]),_:1}),s("span",null,p(l.author),1),e(k),l.installed?(d(),r(g,{key:1,variant:"plain",disabled:""},{default:a(()=>[u("已安装")]),_:1})):(d(),r(g,{key:0,variant:"plain",onClick:i=>{t.extension_url=l.repo,t.newExtension()}},{default:a(()=>[u("安装")]),_:2},1032,["onClick"]))])]),_:2},1032,["title","link"]))]),_:2},1024))),256))]),_:1}),e(w,{modelValue:t.configDialog,"onUpdate:modelValue":o[1]||(o[1]=l=>t.configDialog=l),width:"750"},{activator:a(({props:l})=>[]),default:a(()=>[e(C,null,{default:a(()=>[e(V,null,{default:a(()=>[it]),_:1}),e(y,null,{default:a(()=>[e($,null,{default:a(()=>[e(I,{config:t.extension_config},null,8,["config"])]),_:1})]),_:1}),e(E,null,{default:a(()=>[e(k),e(g,{color:"blue-darken-1",variant:"text",onClick:t.updateConfig},{default:a(()=>[u(" 保存并关闭 ")]),_:1},8,["onClick"]),e(g,{color:"blue-darken-1",variant:"text",onClick:o[0]||(o[0]=l=>t.configDialog=!1)},{default:a(()=>[u(" 关闭 ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(w,{modelValue:t.dialog,"onUpdate:modelValue":o[6]||(o[6]=l=>t.dialog=l),persistent:"",width:"700"},{activator:a(({props:l})=>[e(g,B(l,{icon:"mdi-plus",size:"x-large",style:{position:"fixed",right:"52px",bottom:"52px"},color:"darkprimary"}),null,16)]),default:a(()=>[e(C,null,{default:a(()=>[e(V,null,{default:a(()=>[st]),_:1}),e(y,null,{default:a(()=>[e($,null,{default:a(()=>[e(b,null,{default:a(()=>[dt,e(_,{cols:"12"},{default:a(()=>[ut,e(U,{label:"仓库链接",modelValue:t.extension_url,"onUpdate:modelValue":o[2]||(o[2]=l=>t.extension_url=l),variant:"outlined",required:""},null,8,["modelValue"])]),_:1})]),_:1}),e(b,null,{default:a(()=>[rt,e(_,{cols:"12"},{default:a(()=>[gt,e(J,{label:"选择文件",modelValue:t.upload_file,"onUpdate:modelValue":o[3]||(o[3]=l=>t.upload_file=l),accept:".zip",outlined:"",required:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),pt,s("small",null,p(t.status),1)]),_:1}),e(E,null,{default:a(()=>[e(k),e(g,{color:"blue-darken-1",variant:"text",onClick:o[4]||(o[4]=l=>t.dialog=!1)},{default:a(()=>[u(" 关闭 ")]),_:1}),e(g,{color:"blue-darken-1",variant:"text",loading:t.loading_,onClick:o[5]||(o[5]=l=>t.newExtension())},{default:a(()=>[u(" 安装 ")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(w,{modelValue:t.loadingDialog.show,"onUpdate:modelValue":o[8]||(o[8]=l=>t.loadingDialog.show=l),width:"700",persistent:""},{default:a(()=>[e(C,null,{default:a(()=>[e(V,null,{default:a(()=>[s("span",ht,p(t.loadingDialog.title),1)]),_:1}),e(y,null,{default:a(()=>[e($,null,{default:a(()=>[e(b,null,{default:a(()=>[e(_,{cols:"12"},{default:a(()=>[t.loadingDialog.statusCode===0?(d(),r(K,{key:0,indeterminate:"",color:"primary"})):v("",!0)]),_:1})]),_:1}),t.loadingDialog.statusCode!==0?(d(),c("div",ct,[t.loadingDialog.statusCode===1?(d(),r(D,{key:0,class:"mb-6",color:"success",icon:"mdi-check-circle-outline",size:"128"})):v("",!0),t.loadingDialog.statusCode===2?(d(),r(D,{key:1,class:"mb-6",color:"error",icon:"mdi-alert-circle-outline",size:"128"})):v("",!0),s("div",ft,p(t.loadingDialog.result),1)])):v("",!0),s("div",mt,[_t,e(F,{historyNum:"10",style:{height:"200px","margin-top":"16px"}})])]),_:1})]),_:1}),e(E,null,{default:a(()=>[e(k),e(g,{color:"blue-darken-1",variant:"text",onClick:o[7]||(o[7]=l=>t.resetLoadingDialog())},{default:a(()=>[u(" 关闭 ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(W,{timeout:2e3,elevation:"24",color:t.snack_success,modelValue:t.snack_show,"onUpdate:modelValue":o[9]||(o[9]=l=>t.snack_show=l)},{default:a(()=>[u(p(t.snack_message),1)]),_:1},8,["color","modelValue"]),e(P,{ref:"wfr"},null,512)],64))}});export{xt as default};
